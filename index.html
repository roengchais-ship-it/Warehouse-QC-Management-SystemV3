<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warehouse QC Enterprise v3.13 (Fix ReferenceError)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Check if library loaded, fallback if needed
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(14, 165, 233, 0.3)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        .animate-pop { animation: pop 0.2s ease-out; }
        .animate-spin-slow { animation: spin 3s linear infinite; }

        .item-row { position: relative; transition: z-index 0s; }
        .item-row:focus-within { z-index: 50; } 
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 80px); }
        
        .btn-main {
            width: 100%; height: 56px; border-radius: 16px; font-size: 1.125rem; font-weight: 700;
            color: white; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            transition: all 0.2s; position: relative; overflow: hidden; cursor: pointer;
        }
        .btn-main:active { transform: scale(0.98); }
        
        .btn-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.4); }
        .btn-orange { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); box-shadow: 0 10px 20px -5px rgba(249, 115, 22, 0.4); }
        .btn-rose { background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%); box-shadow: 0 10px 20px -5px rgba(244, 63, 94, 0.4); }
        .btn-emerald { background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.4); }
        .btn-purple { background: linear-gradient(135deg, #a855f7 0%, #7e22ce 100%); box-shadow: 0 10px 20px -5px rgba(168, 85, 247, 0.4); }
        .btn-grey { background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }

        .input-field {
            border: 1px solid #e2e8f0; background-color: white; border-radius: 0.75rem;
            padding: 0.75rem; transition: all 0.2s; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        .progress-bar { transition: width 0.3s ease; }
        
        /* Status Indicator */
        #cloud-status { position: fixed; bottom: 10px; right: 10px; z-index: 100; font-size: 11px; opacity: 0.9; background: white; padding: 6px 12px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 6px; font-weight: 500; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen flex flex-col overflow-hidden selection:bg-brand-100">

    <div id="toast-container" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-[90] flex flex-col gap-2 pointer-events-none w-full max-w-xs px-4"></div>
    <div id="cloud-status">
        <span class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-slate-500"></span>
        </span>
        Checking...
    </div>

    <div id="modal-overlay" class="fixed inset-0 z-[80] bg-slate-900/40 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-200 p-4">
        <div id="modal-content" class="bg-white w-full max-w-md rounded-3xl shadow-2xl transform scale-95 transition-transform duration-200 overflow-hidden flex flex-col max-h-[85vh]"></div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-50 flex flex-col items-center justify-center p-6 hidden">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-8 border border-slate-100">
            <div class="flex flex-col items-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-400 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-200 mb-4">
                    <i data-lucide="package-check" class="w-8 h-8 text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">Warehouse QC</h1>
                <p class="text-sm text-slate-400">Enterprise Edition v3.13</p>
            </div>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500 mb-1.5 block ml-1">ชื่อผู้ใช้</label><input type="text" id="login-username" class="input-field w-full" placeholder="username"></div>
                <div><label class="text-xs font-bold text-slate-500 mb-1.5 block ml-1">รหัสผ่าน</label><input type="password" id="login-password" class="input-field w-full" placeholder="password"></div>
                <button onclick="app.auth.login()" class="btn-main btn-blue mt-6 shadow-lg shadow-blue-200">เข้าใช้งาน</button>
            </div>
        </div>
        <p class="mt-8 text-xs text-slate-400">รหัสเริ่มต้น: 1234</p>
    </div>

    <!-- Header -->
    <header id="main-header" class="glass h-16 fixed top-0 w-full z-30 flex items-center justify-between px-4 lg:px-8 transition-all duration-300 hidden">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-blue-600 to-blue-400 text-white p-2 rounded-xl shadow-lg shadow-blue-200">
                <i data-lucide="package-check" class="w-5 h-5"></i>
            </div>
            <div><h1 class="font-bold text-lg leading-tight text-slate-800">Warehouse QC</h1></div>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-3 pl-4 border-l border-slate-200 cursor-pointer hover:bg-slate-50 p-1 rounded-xl" onclick="app.auth.showProfileMenu()">
                <div class="text-right hidden md:block">
                    <p id="header-username" class="text-xs font-bold text-slate-700">User</p>
                    <p id="header-role" class="text-[10px] text-slate-400">Role</p>
                </div>
                <div class="w-9 h-9 rounded-full bg-slate-200 p-0.5 border border-slate-200 shadow-sm overflow-hidden">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="Avatar" class="h-full w-full">
                </div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div id="main-layout" class="flex h-full pt-16 hidden">
        <aside class="hidden lg:flex flex-col w-64 bg-white border-r border-slate-200 h-full shadow-[2px_0_20px_rgba(0,0,0,0.02)] z-20">
            <nav class="flex-1 p-4 space-y-1" id="desktop-nav"></nav>
            <div class="p-4 border-t border-slate-100">
                <button onclick="app.auth.logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-rose-500 hover:bg-rose-50 transition-all">
                    <i data-lucide="log-out" class="w-5 h-5"></i> ออกจากระบบ
                </button>
                <p class="text-[10px] text-slate-400 text-center mt-3 font-mono">v3.13 (Enterprise)</p>
            </div>
        </aside>

        <main id="main-view" class="flex-1 overflow-y-auto bg-slate-50 relative pb-safe"></main>

        <button id="fab-create" onclick="app.router('create')" class="fixed bottom-24 lg:bottom-10 right-4 lg:right-10 w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-500 text-white rounded-full shadow-lg shadow-blue-300/50 flex items-center justify-center hover:scale-105 active:scale-95 transition-all z-40 group hidden">
            <i data-lucide="plus" class="w-8 h-8 group-hover:rotate-90 transition-transform duration-300"></i>
        </button>
    </div>

    <nav id="mobile-nav" class="lg:hidden fixed bottom-0 w-full bg-white/95 backdrop-blur border-t border-slate-200 flex justify-around items-center h-[70px] z-40 pb-safe shadow-[0_-4px_20px_rgba(0,0,0,0.03)] transition-transform duration-300 hidden"></nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ตั้งค่า Firebase ของคุณที่นี่ ---
        const firebaseConfig = {
            apiKey: "AIzaSyC_gvuDL3XqwBpU1Ns3VSILDOCaf9n6Uik",
            authDomain: "warehouse-qc-management-system.firebaseapp.com",
            projectId: "warehouse-qc-management-system",
            storageBucket: "warehouse-qc-management-system.firebasestorage.app",
            messagingSenderId: "1033934968682",
            appId: "1:1033934968682:web:9a4cfd06d0d5335d527713",
            measurementId: "G-JX6KLL0PJS"
        };
        // ----------------------------------
        
        const appId = 'warehouse-qc-main'; // ตั้งชื่อ App ID ที่นี่

        // Global Firebase Handler
        window.firebaseHandler = {
            db: null,
            docRef: null,
            isConnected: false,
            init: async () => {
                const statusEl = document.getElementById('cloud-status');
                
                // 1. Check Internet Connection
                if (!navigator.onLine) {
                     if(statusEl) statusEl.innerHTML = '<span class="text-slate-400"><i data-lucide="wifi-off" class="w-3 h-3 inline"></i> Offline Mode</span>';
                     lucide.createIcons();
                }
                
                window.addEventListener('offline', () => {
                    if(statusEl) statusEl.innerHTML = '<span class="text-rose-500"><i data-lucide="wifi-off" class="w-3 h-3 inline"></i> No Internet</span>';
                    lucide.createIcons();
                });
                
                window.addEventListener('online', () => {
                     if(statusEl) statusEl.innerHTML = '<span class="text-blue-500"><i data-lucide="refresh-cw" class="w-3 h-3 inline animate-spin"></i> Reconnecting...</span>';
                     lucide.createIcons();
                });

                // 2. Check Config Validation
                if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                    console.warn("Firebase Config not setup.");
                    if(statusEl) {
                        statusEl.innerHTML = '<span class="text-slate-500 flex items-center gap-1"><i data-lucide="hard-drive" class="w-3 h-3"></i> Local Mode (No Sync)</span>';
                        lucide.createIcons();
                    }
                    return;
                }

                try {
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    window.firebaseHandler.db = db;
                    
                    // Try to use provided initial auth token if available, otherwise anonymous
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                             await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (e) {
                             console.warn("Custom token auth failed, falling back to anonymous", e);
                             await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            const colRef = collection(db, 'warehouse_data');
                            window.firebaseHandler.docRef = doc(colRef, appId);
                            
                            // LISTEN FOR CLOUD UPDATES
                            onSnapshot(window.firebaseHandler.docRef, (docSnap) => {
                                window.firebaseHandler.isConnected = true;
                                if(statusEl) {
                                    statusEl.innerHTML = '<span class="text-emerald-600 flex items-center gap-1 font-bold"><span class="relative flex h-2 w-2 mr-1"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span></span> Cloud Synced</span>';
                                    lucide.createIcons();
                                }

                                if (docSnap.exists()) {
                                    const cloudData = docSnap.data();
                                    
                                    // MERGE STRATEGY: Cloud Wins
                                    if(cloudData && cloudData.orders) {
                                        window.app.data = cloudData;
                                        window.app.saveLocal(); 
                                        
                                        if(window.app.currentUser) {
                                            window.app.updateBadges();
                                            // *** FIX: Use refreshDetail logic to prevent jumps if already on page ***
                                            // Only hard reload if not on a detail page or if page is empty
                                            const main = document.getElementById('main-view');
                                            if(main && main.innerHTML !== "") {
                                                if(window.app.currentPage === 'detail' && window.app.currentParam) {
                                                    // Soft update for detail page (keep scroll)
                                                    window.app.logic.refreshDetail(window.app.currentParam);
                                                } else {
                                                    // Standard update for other pages
                                                    window.app.router(window.app.currentPage, window.app.currentParam);
                                                }
                                            }
                                        }
                                    } 
                                } else {
                                    // Initialize Cloud if empty
                                    window.firebaseHandler.save(window.app.data);
                                }
                            }, (error) => {
                                console.error("Sync error:", error);
                                window.firebaseHandler.isConnected = false;
                                if(statusEl) statusEl.innerHTML = '<span class="text-rose-500">Sync Error (Check Console)</span>';
                            });
                        }
                    });
                } catch (err) {
                    console.error("Firebase Init Failed:", err);
                    if(statusEl) statusEl.innerHTML = '<span class="text-rose-500">Config Error</span>';
                }
            },
            save: (data) => {
                if (window.firebaseHandler.docRef) {
                    const statusEl = document.getElementById('cloud-status');
                    if(statusEl) {
                         const original = statusEl.innerHTML;
                         statusEl.innerHTML = '<span class="text-blue-500 flex items-center gap-1"><i data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i> Saving...</span>';
                         lucide.createIcons();
                    }
                    
                    setDoc(window.firebaseHandler.docRef, JSON.parse(JSON.stringify(data)))
                        .then(() => {
                            // Status will revert on snapshot update
                        })
                        .catch(err => {
                            console.error("Save error", err);
                        });
                }
            }
        };

        // Start
        window.firebaseHandler.init();
    </script>

    <script>
        const LOCAL_STORAGE_KEY = 'warehouse_qc_data_v3_gh'; 

        const ROLES = {
            admin: { name: 'ผู้ดูแลระบบ', allowed: ['dashboard', 'inventory', 'stock', 'qc', 'pack', 'ship', 'history', 'detail', 'create'] }, 
            manager: { name: 'หัวหน้างาน', allowed: ['dashboard', 'inventory', 'stock', 'qc', 'pack', 'ship', 'history', 'create', 'detail'] },
            stock: { name: 'ทีม Stock', allowed: ['dashboard', 'stock', 'inventory', 'history', 'detail'] }, 
            qc: { name: 'ทีม QC', allowed: ['dashboard', 'qc', 'history', 'detail'] },
            pack: { name: 'ทีม Pack', allowed: ['dashboard', 'pack', 'ship', 'history', 'create', 'detail'] }
        };

        const MENU_ITEMS = [
            { id: 'dashboard', label: 'ภาพรวม', icon: 'layout-grid', mobile: true, badge: false },
            { id: 'inventory', label: 'คลังสินค้า', icon: 'warehouse', mobile: true, badge: false }, 
            { id: 'stock', label: 'เบิกสินค้า', icon: 'layers', mobile: true, badge: true, badgeColor: 'bg-orange-500' },
            { id: 'qc', label: 'QC', icon: 'clipboard-check', mobile: true, badge: true, badgeColor: 'bg-rose-500' },
            { id: 'pack', label: 'แพ็ค', icon: 'box', mobile: true, badge: true, badgeColor: 'bg-blue-500' },
            { id: 'ship', label: 'จัดส่ง', icon: 'truck', mobile: false, badge: true, badgeColor: 'bg-emerald-500' }, 
            { id: 'history', label: 'ประวัติ', icon: 'clock', mobile: true, badge: false }
        ];

        const app = {
            data: { orders: [], products: [], users: {} },
            currentUser: null,
            currentPage: 'dashboard',
            currentParam: null,
            session: {}, 
            
            init() {
                // Initialize Auth UI
                ['login-username', 'login-password'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.addEventListener('keyup', (e) => {
                            if (e.key === 'Enter') id === 'login-username' ? document.getElementById('login-password').focus() : this.auth.login();
                        });
                    }
                });
                
                // Initialize Data from LocalStorage FIRST (Instant load)
                this.loadDataLocal();

                // Check Session
                const sessionUser = localStorage.getItem('warehouse_session_user');
                if (sessionUser) { 
                    this.currentUser = JSON.parse(sessionUser); 
                    this.startApp(); 
                } else { 
                    this.showLogin(); 
                }
            },

            loadDataLocal() {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (stored) { 
                    this.data = JSON.parse(stored); 
                    if (!this.data.products) this.data.products = [];
                } else {
                    this.seedData(); 
                }
            },
            
            saveLocal() {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(this.data));
            },

            saveData() {
                // 1. Always save locally (Backup & Speed)
                this.saveLocal();

                // 2. Try to save to Cloud
                if(window.firebaseHandler && window.firebaseHandler.docRef) {
                    window.firebaseHandler.save(this.data);
                }
                
                this.updateBadges();
            },

            seedData() {
                this.data = {
                    users: {
                        'admin': { pass: '1234', role: 'admin', name: 'Admin' },
                        'manager': { pass: '1234', role: 'manager', name: 'Manager' },
                        'stock': { pass: '1234', role: 'stock', name: 'Stock Team' },
                        'qc': { pass: '1234', role: 'qc', name: 'QC Team' },
                        'pack': { pass: '1234', role: 'pack', name: 'Pack Team' }
                    },
                    products: [
                        { sku: 'FG1-ABDF130-CR', name: 'Ambient Diffuser (Charlene rose)', barcode: '885000000001' },
                        { sku: 'FG1-ABDF130-PF', name: 'Ambient Diffuser (Pine forest)', barcode: '885000000002' },
                        { sku: 'BAG-PPGR--20X28', name: 'ถุงกระดาษสีเขียว 20x28 cm', barcode: 'BAG2028' },
                        { sku: 'FG2-CANDLE-V1', name: 'Scented Candle - Vanilla Dream', barcode: '885000000003' },
                        { sku: 'FG2-CANDLE-LAV', name: 'Scented Candle - Lavender Field', barcode: '885000000004' }
                    ],
                    orders: []
                };
                this.saveData();
            },

            auth: {
                login() {
                    const u = document.getElementById('login-username').value;
                    const p = document.getElementById('login-password').value;
                    if ((app.data.users && app.data.users[u] && app.data.users[u].pass === p) || (u==='admin' && p==='1234')) {
                        const userData = app.data.users[u] || { role: 'admin', name: 'Admin' };
                        app.currentUser = { username: u, ...userData };
                        localStorage.setItem('warehouse_session_user', JSON.stringify(app.currentUser));
                        app.startApp();
                    } else { app.ui.toast('ข้อมูลไม่ถูกต้อง', 'error'); }
                },
                logout() {
                    app.currentUser = null;
                    localStorage.removeItem('warehouse_session_user');
                    location.reload();
                },
                showProfileMenu() {
                    app.ui.modalHTML('ข้อมูลผู้ใช้', `
                        <div class="text-center py-4">
                            <div class="w-20 h-20 bg-slate-200 rounded-full mx-auto mb-3 overflow-hidden"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="w-full h-full"></div>
                            <h3 class="font-bold text-lg">${app.currentUser.name}</h3>
                            <p class="text-slate-500">${ROLES[app.currentUser.role]?.name || 'User'}</p>
                            <button onclick="app.auth.logout()" class="mt-6 w-full btn-grey h-12 rounded-xl text-rose-600 font-bold">ออกจากระบบ</button>
                        </div>
                    `, () => {}, 'ปิด');
                    document.getElementById('modal-cancel').style.display = 'none';
                }
            },

            startApp() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-header').classList.remove('hidden');
                document.getElementById('main-layout').classList.remove('hidden');
                document.getElementById('mobile-nav').classList.remove('hidden');
                if(this.currentUser) {
                    document.getElementById('header-username').innerText = this.currentUser.name;
                    document.getElementById('header-role').innerText = ROLES[this.currentUser.role]?.name || 'N/A';
                    this.renderNavigation();
                    this.router('dashboard');
                    this.updateBadges();
                }
            },

            showLogin() { document.getElementById('login-screen').classList.remove('hidden'); },

            renderNavigation() {
                const allowed = ROLES[this.currentUser.role]?.allowed || [];
                const desktopNav = document.getElementById('desktop-nav');
                const mobileNav = document.getElementById('mobile-nav');

                desktopNav.innerHTML = MENU_ITEMS.map(item => {
                    if (allowed.includes(item.id)) {
                        let badgeHtml = item.badge ? `<span id="d-badge-${item.id}" class="${item.badgeColor} text-white text-[10px] px-2 py-0.5 rounded-full hidden">0</span>` : '';
                        return `<button onclick="app.router('${item.id}')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all hover:bg-slate-50 text-slate-500" data-page="${item.id}"><i data-lucide="${item.icon}" class="w-5 h-5"></i><span class="flex-1 text-left">${item.label}</span>${badgeHtml}</button>`;
                    } return '';
                }).join('');

                mobileNav.innerHTML = MENU_ITEMS.filter(i => i.mobile).map(item => {
                    if (allowed.includes(item.id)) {
                        let badgeHtml = item.badge ? `<span id="m-badge-${item.id}" class="absolute top-1 right-3 min-w-[16px] h-4 flex items-center justify-center ${item.badgeColor} text-white text-[9px] px-1 rounded-full hidden">0</span>` : '';
                        return `<button onclick="app.router('${item.id}')" class="mobile-nav-item flex flex-col items-center justify-center w-full h-full gap-1 text-slate-400 relative" data-page="${item.id}"><i data-lucide="${item.icon}" class="w-6 h-6"></i><span class="text-[10px] font-medium">${item.label}</span>${badgeHtml}</button>`;
                    } return '';
                }).join('');

                const fab = document.getElementById('fab-create');
                if (allowed.includes('create')) fab.classList.remove('hidden');
                lucide.createIcons();
            },

            updateBadges() {
                if(!this.data.orders) return;
                const counts = {
                    stock: this.data.orders.filter(o => o.status === 'pending_stock').length,
                    qc: this.data.orders.filter(o => o.status === 'pending_qc').length,
                    pack: this.data.orders.filter(o => o.status === 'pending_pack').length,
                    ship: this.data.orders.filter(o => o.status === 'ready_ship').length
                };
                Object.keys(counts).forEach(key => {
                    ['d-badge-', 'm-badge-'].forEach(prefix => {
                        const el = document.getElementById(prefix + key);
                        if (el) { el.innerText = counts[key] > 99 ? '99+' : counts[key]; el.classList.toggle('hidden', counts[key] === 0); }
                    });
                });
            },

            router(page, param = null) {
                this.currentPage = page;
                this.currentParam = param;
                const main = document.getElementById('main-view');
                main.innerHTML = '';
                window.scrollTo(0,0);

                document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(el => {
                    const active = el.dataset.page === page;
                    el.classList.toggle('text-brand-600', active);
                    if(el.classList.contains('nav-item')) el.classList.toggle('bg-brand-50', active);
                });

                const fab = document.getElementById('fab-create');
                if(fab) {
                    if(page === 'detail' || page === 'create') fab.classList.add('hidden');
                    else if(ROLES[this.currentUser.role]?.allowed.includes('create')) fab.classList.remove('hidden');
                }

                switch(page) {
                    case 'dashboard': this.views.renderDashboard(main); break;
                    case 'inventory': this.views.renderInventory(main); break;
                    case 'stock': this.views.renderList(main, 'pending_stock', 'เบิกสินค้า', 'layers', 'bg-orange-100 text-orange-600'); break;
                    case 'qc': this.views.renderList(main, 'pending_qc', 'QC ตรวจสอบ', 'clipboard-check', 'bg-rose-100 text-rose-600'); break;
                    case 'pack': this.views.renderList(main, 'pending_pack', 'แพ็คสินค้า', 'box', 'bg-blue-100 text-blue-600'); break;
                    case 'ship': this.views.renderList(main, 'ready_ship', 'จัดส่ง', 'truck', 'bg-emerald-100 text-emerald-600'); break;
                    case 'history': this.views.renderHistory(main); break;
                    case 'detail': this.views.renderDetail(main, param); break;
                    case 'create': this.views.renderCreateOrder(main); break;
                }
                lucide.createIcons();
            },

            views: {
                renderInventory(container) {
                    container.innerHTML = `
                        <div class="p-4 lg:p-8 space-y-6 animate-fade-in max-w-5xl mx-auto pb-32">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="p-3 bg-purple-100 text-purple-600 rounded-2xl"><i data-lucide="warehouse" class="w-6 h-6"></i></div>
                                    <div><h2 class="text-2xl font-bold text-slate-800">คลังสินค้า (Master Data)</h2><p class="text-xs text-slate-500">จัดการข้อมูล SKU และ Barcode</p></div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="app.logic.openAddProductModal()" class="btn-main btn-blue !w-auto !h-10 px-4 text-sm shadow-none"><i data-lucide="plus" class="w-4 h-4"></i> เพิ่มสินค้า</button>
                                    <button onclick="app.logic.openImportInventory()" class="btn-main btn-purple !w-auto !h-10 px-4 text-sm shadow-none"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Import Excel</button>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-3xl shadow-soft border border-slate-100">
                                <div class="relative">
                                    <i data-lucide="search" class="absolute left-3 top-3 w-5 h-5 text-slate-400"></i>
                                    <input type="text" id="inv-search" class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:ring-2 focus:ring-purple-200 outline-none text-sm" placeholder="ค้นหา ชื่อสินค้า, SKU, Barcode..." oninput="app.views.renderInventoryList()">
                                </div>
                            </div>
                            <div id="inventory-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                        </div>
                    `;
                    this.renderInventoryList();
                },

                renderInventoryList() {
                    const search = document.getElementById('inv-search')?.value.toLowerCase() || '';
                    const list = app.data.products.filter(p => 
                        p.name.toLowerCase().includes(search) || 
                        p.sku.toLowerCase().includes(search) || 
                        (p.barcode && p.barcode.includes(search))
                    );
                    const html = list.length === 0 
                        ? `<div class="col-span-full text-center py-10 text-slate-400">ไม่พบข้อมูลสินค้า</div>` 
                        : list.map(p => `
                            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-100 transition-opacity"><i data-lucide="package" class="w-16 h-16 text-purple-600"></i></div>
                                
                                <button onclick="app.logic.deleteProduct('${p.sku}')" class="absolute top-3 right-3 z-20 p-2 bg-white/50 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-lg transition-colors border border-transparent hover:border-red-100">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>

                                <div class="relative z-10 pr-8">
                                    <div class="flex items-start justify-between mb-2">
                                        <span class="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded border border-slate-200">SKU: ${p.sku}</span>
                                    </div>
                                    ${p.barcode ? `<div class="flex items-center gap-1 text-[10px] font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded w-fit mb-2"><i data-lucide="scan-barcode" class="w-3 h-3"></i> ${p.barcode}</div>` : ''}
                                    <h3 class="font-bold text-slate-800 text-sm mb-1 line-clamp-2">${p.name}</h3>
                                </div>
                            </div>
                        `).join('');
                    document.getElementById('inventory-list').innerHTML = html;
                    lucide.createIcons();
                },

                renderHistory(container) {
                    const list = app.data.orders ? app.data.orders.filter(o => o.status === 'completed') : [];
                    container.innerHTML = `
                        <div class="p-4 lg:p-8 space-y-6 animate-fade-in pb-32 max-w-3xl mx-auto">
                            <div class="flex items-center gap-4 mb-6">
                                <div class="p-3 rounded-2xl bg-slate-100 text-slate-600 shadow-sm"><i data-lucide="clock" class="w-7 h-7"></i></div>
                                <div><h2 class="text-2xl font-bold text-slate-800">ประวัติ (History)</h2><p class="text-sm text-slate-500">ออเดอร์ที่เสร็จสมบูรณ์ (${list.length})</p></div>
                            </div>
                            <div class="space-y-4">
                                ${list.length === 0 ? `<div class="text-center py-20 text-slate-400 border-2 border-dashed border-slate-200 rounded-3xl">ไม่พบประวัติ</div>` : list.map(o => `
                                    <div onclick="app.router('detail', '${o.id}')" class="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 active:scale-[0.98] transition-all cursor-pointer hover:shadow-lg hover:border-brand-200 relative group">
                                        <div class="absolute top-4 right-4 z-10">
                                            <button onclick="event.stopPropagation(); app.logic.deleteOrder('${o.id}')" class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors" title="ลบออเดอร์">
                                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                            </button>
                                        </div>
                                        <div class="flex justify-between items-start mb-3"><span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-lg border border-slate-200">${o.id}</span><span class="text-xs text-slate-400">${o.date}</span></div>
                                        <h3 class="font-bold text-slate-800 text-lg mb-1 group-hover:text-brand-600 transition-colors pr-8">${o.customer}</h3>
                                        <p class="text-sm text-slate-500 bg-slate-50 px-2 py-1 rounded-lg inline-block mb-3"><i data-lucide="file-text" class="w-3 h-3 inline mr-1"></i>${o.docNo}</p>
                                        <div class="flex items-center justify-between border-t border-slate-50 pt-4">
                                            <span class="text-xs font-bold text-slate-500 bg-slate-100 px-3 py-1.5 rounded-full">${o.items.length} รายการสินค้า</span>
                                            <div class="flex items-center gap-1 text-emerald-600 font-bold text-xs">
                                                <i data-lucide="check-circle" class="w-3 h-3"></i>
                                                <span>เสร็จสมบูรณ์</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                     lucide.createIcons();
                },

                renderDashboard(container) {
                    if(!app.data.orders) return;
                    const stats = {
                        stock: app.data.orders.filter(o => o.status === 'pending_stock').length,
                        qc: app.data.orders.filter(o => o.status === 'pending_qc').length,
                        pack: app.data.orders.filter(o => o.status === 'pending_pack').length,
                        ship: app.data.orders.filter(o => o.status === 'ready_ship').length
                    };
                    container.innerHTML = `
                        <div class="p-4 lg:p-8 space-y-6 animate-fade-in max-w-5xl mx-auto">
                            <h2 class="text-2xl font-bold text-slate-800">ภาพรวม (Dashboard)</h2>
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                ${this.cardStat('รอเบิก', stats.stock, 'layers', 'bg-gradient-to-br from-orange-500 to-orange-400 text-white shadow-lg shadow-orange-200')}
                                ${this.cardStat('รอตรวจ QC', stats.qc, 'clipboard-check', 'bg-gradient-to-br from-rose-500 to-rose-400 text-white shadow-lg shadow-rose-200')}
                                ${this.cardStat('รอแพ็ค', stats.pack, 'box', 'bg-gradient-to-br from-blue-500 to-blue-400 text-white shadow-lg shadow-blue-200')}
                                ${this.cardStat('รอส่ง', stats.ship, 'truck', 'bg-gradient-to-br from-emerald-500 to-emerald-400 text-white shadow-lg shadow-emerald-200')}
                            </div>
                            <div class="bg-white rounded-3xl shadow-soft border border-slate-100 overflow-hidden mt-6">
                                <div class="p-6 border-b border-slate-50 flex justify-between items-center"><h3 class="font-bold text-slate-700 text-lg">ออเดอร์ล่าสุด</h3></div>
                                <div class="divide-y divide-slate-50">
                                    ${app.data.orders.slice(0, 5).map(o => `
                                        <div onclick="app.router('detail', '${o.id}')" class="p-5 flex items-center justify-between hover:bg-slate-50 cursor-pointer transition-colors group">
                                            <div class="flex items-center gap-4">
                                                <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 group-hover:bg-brand-50 group-hover:text-brand-600"><i data-lucide="package" class="w-5 h-5"></i></div>
                                                <div><div class="font-bold text-sm text-slate-800">${o.customer}</div><div class="text-xs text-slate-400">${o.docNo} • ${o.items.length} รายการ</div></div>
                                            </div>
                                            ${app.ui.badge(o.status)}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>`;
                },

                renderCreateOrder(container) {
                    container.innerHTML = `
                        <div class="animate-slide-in-right min-h-full flex flex-col bg-slate-50 relative pb-20">
                            <div class="bg-white/90 backdrop-blur border-b border-slate-200 p-4 sticky top-0 z-30 flex items-center gap-3 shadow-sm">
                                <button onclick="app.router(app.activeTab)" class="p-2 -ml-2 text-slate-500 hover:bg-slate-100 rounded-full"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                                <h2 class="font-bold text-slate-800 text-lg">สร้างออเดอร์ใหม่</h2>
                            </div>
                            <div class="p-6 space-y-6 w-full flex-1">
                                <div class="bg-white p-5 rounded-3xl shadow-soft border border-slate-100 space-y-4">
                                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="file-text" class="w-5 h-5 text-brand-500"></i> ข้อมูลเอกสาร</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label class="text-xs font-bold text-slate-500 mb-1.5 block">เลขที่เอกสาร</label><input type="text" id="new-doc" class="input-field w-full" placeholder="PO-XXXX"></div>
                                        <div><label class="text-xs font-bold text-slate-500 mb-1.5 block">วันที่</label><input type="date" id="new-date" class="input-field w-full"></div>
                                    </div>
                                    <div><label class="text-xs font-bold text-slate-500 mb-1.5 block">ชื่อลูกค้า</label><input type="text" id="new-customer" class="input-field w-full" placeholder="ระบุชื่อลูกค้า..."></div>
                                </div>
                                <div class="bg-white p-5 rounded-3xl shadow-soft border border-slate-100 space-y-4">
                                    <div class="flex justify-between items-center">
                                        <h3 class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="package" class="w-5 h-5 text-brand-500"></i> รายการสินค้า</h3>
                                        <button onclick="app.logic.openImportOrderExcel()" class="text-xs font-bold bg-green-50 text-green-600 px-3 py-1.5 rounded-lg border border-green-100 hover:bg-green-100 flex items-center gap-1 transition-colors"><i data-lucide="file-down" class="w-4 h-4"></i> Import Excel / PDF</button>
                                    </div>
                                    <div class="grid grid-cols-[180px_1fr_100px_100px_60px] gap-3 text-xs font-bold text-slate-400 px-2">
                                        <div>SKU</div>
                                        <div>ชื่อสินค้า (ค้นหา)</div>
                                        <div class="text-center">จน.</div>
                                        <div class="text-center">หน่วย</div>
                                        <div></div>
                                    </div>
                                    <div id="new-items-list" class="space-y-3 pb-4"></div>
                                    <button onclick="app.logic.addInputRow()" class="w-full h-10 rounded-xl bg-brand-50 text-brand-600 font-bold border border-brand-100 hover:bg-brand-100 transition-all flex items-center justify-center gap-2 text-sm"><i data-lucide="plus" class="w-4 h-4"></i> เพิ่มรายการสินค้า</button>
                                </div>
                            </div>
                            <div class="fixed bottom-0 w-full bg-white/90 backdrop-blur border-t border-slate-200 p-5 z-30 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
                                <div class="w-full"><button onclick="app.logic.submitNewOrder()" class="btn-main btn-blue">บันทึกออเดอร์</button></div>
                            </div>
                        </div>`;
                    document.getElementById('new-date').valueAsDate = new Date();
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.group-input')) { document.querySelectorAll('.suggestions-box').forEach(el => el.classList.add('hidden')); }
                    });
                    app.logic.addInputRow();
                },

                renderDetail(container, id) {
                    const order = app.data.orders.find(o => o.id === id);
                    if (!order) return app.router('dashboard');
                    
                    // Init Box Tracking
                    if (!order.boxes) order.boxes = [];
                    if (!order.active_box) order.active_box = { items: {}, total_qty: 0 };

                    let content = ''; let footer = '';
                    const role = app.currentUser.role;
                    const canEdit = role === 'manager' || (role === 'stock' && order.status === 'pending_stock') || (role === 'qc' && order.status === 'pending_qc') || (role === 'pack' && (order.status === 'pending_pack' || order.status === 'ready_ship'));

                    if (order.status === 'pending_stock') {
                        content = this.renderStockContent(order, canEdit);
                        if (canEdit) footer = `<button onclick="app.logic.validateStock('${id}')" class="btn-main btn-orange">ยืนยันส่งตรวจสอบ</button>`;
                    } else if (order.status === 'pending_qc') {
                        content = this.renderQCContent(order, canEdit);
                        if (canEdit) footer = `<button onclick="app.logic.submitQC('${id}')" class="btn-main btn-rose">บันทึกผล QC</button>`;
                    } else if (order.status === 'pending_pack') {
                        content = this.renderPackContent(order, canEdit);
                        // CHANGED: Side-by-side buttons for printing and confirming
                        footer = `<div class="flex gap-3 items-stretch">
                             <button class="w-24 px-2 btn-grey rounded-2xl font-bold flex flex-col items-center justify-center gap-1 text-[10px] text-slate-500 active:scale-95 transition-transform" onclick="app.logic.printPackingList('${order.id}')">
                                <i data-lucide="printer" class="w-5 h-5"></i>
                                <span>พิมพ์ใบรวม</span>
                             </button>
                             ${canEdit ? `<button onclick="app.logic.moveStatus('${id}', 'ready_ship', 'แพ็คเสร็จสิ้น')" class="flex-1 btn-main btn-blue shadow-lg shadow-blue-200">ยืนยันแพ็คเสร็จสิ้น</button>` : ''}
                        </div>`;
                    } else if (order.status === 'ready_ship') {
                        content = this.renderReadOnlyContent(order);
                        if (canEdit) footer = `<button onclick="app.logic.moveStatus('${id}', 'completed', 'จัดส่งแล้ว')" class="btn-main btn-emerald">ยืนยันการจัดส่ง</button>`;
                    } else { content = this.renderReadOnlyContent(order); }

                    container.innerHTML = `
                        <div class="animate-slide-in-right h-full flex flex-col bg-slate-50">
                            <div class="bg-white/80 backdrop-blur-md border-b border-slate-200 p-4 sticky top-0 z-20 flex items-center gap-3 shadow-sm">
                                <button onclick="app.router(app.activeTab)" class="p-2 -ml-2 text-slate-500 hover:bg-slate-100 rounded-full"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                                <div class="flex-1 min-w-0"><h2 class="font-bold text-slate-800 truncate text-lg">${order.customer}</h2><div class="flex items-center gap-2 text-xs text-slate-500 mt-0.5"><span>${order.docNo}</span></div></div>
                                <div class="ml-auto scale-90 origin-right">${app.ui.badge(order.status)}</div>
                            </div>
                            <div id="detail-scroller" class="flex-1 overflow-y-auto p-4 lg:p-6 space-y-6 pb-40 w-full">
                                ${content}
                                <div class="border-t border-slate-200 pt-8 mt-4"><h3 class="font-bold text-slate-700 mb-4 text-sm uppercase">ประวัติออเดอร์</h3><div class="space-y-0 pl-2 border-l-2 border-slate-200 ml-2">${order.logs.map(log => `<div class="relative pl-6 pb-6 last:pb-0"><div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-white border-2 border-slate-300"></div><p class="text-sm font-bold text-slate-700">${log.action}</p><p class="text-xs text-slate-400 mt-0.5">${log.time} • ${log.user}</p></div>`).join('')}</div></div>
                            </div>
                            ${footer ? `<div class="fixed lg:absolute bottom-0 w-full lg:w-auto left-0 right-0 bg-white/90 backdrop-blur border-t border-slate-200 p-5 z-50 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">${footer}</div>` : ''}
                        </div>`;
                    
                    if(order.status === 'pending_pack' && canEdit) {
                        setTimeout(() => { document.getElementById('pack-scan-input')?.focus(); }, 300);
                    }
                },

                renderList(container, status, title, icon, bgClass) {
                    const list = app.data.orders.filter(o => o.status === status);
                    container.innerHTML = `
                        <div class="p-4 lg:p-8 space-y-6 animate-fade-in pb-32 max-w-3xl mx-auto">
                            <div class="flex items-center gap-4 mb-6">
                                <div class="p-3 rounded-2xl ${bgClass} shadow-sm"><i data-lucide="${icon}" class="w-7 h-7"></i></div>
                                <div><h2 class="text-2xl font-bold text-slate-800">${title}</h2><p class="text-sm text-slate-500">${list.length} รายการ</p></div>
                            </div>
                            <div class="space-y-4">
                                ${list.length === 0 ? `<div class="text-center py-20 text-slate-400 border-2 border-dashed border-slate-200 rounded-3xl">ไม่พบรายการ</div>` : list.map(o => `
                                    <div onclick="app.router('detail', '${o.id}')" class="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 active:scale-[0.98] transition-all cursor-pointer hover:shadow-lg hover:border-brand-200 relative group">
                                        ${o.docNo.includes('(Rework)') ? '<div class="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-3 py-1 rounded-bl-xl font-bold">Rework</div>' : ''}
                                        <div class="flex justify-between items-start mb-3"><span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-lg border border-slate-200">${o.id}</span><span class="text-xs text-slate-400">${o.date.split(',')[0]}</span></div>
                                        <h3 class="font-bold text-slate-800 text-lg mb-1 group-hover:text-brand-600 transition-colors">${o.customer}</h3>
                                        <p class="text-sm text-slate-500 bg-slate-50 px-2 py-1 rounded-lg inline-block mb-3"><i data-lucide="file-text" class="w-3 h-3 inline mr-1"></i>${o.docNo}</p>
                                        <div class="flex items-center justify-between border-t border-slate-50 pt-4"><span class="text-xs font-bold text-slate-500 bg-slate-100 px-3 py-1.5 rounded-full">${o.items.length} รายการสินค้า</span><i data-lucide="chevron-right" class="w-5 h-5 text-slate-300"></i></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                },

                renderStockContent(order, canEdit) {
                    return `<div class="space-y-4">${order.items.map((item, idx) => {
                        const totalPicked = item.picks.reduce((a, b) => a + (parseInt(b.qty)||0), 0);
                        const statusColor = totalPicked > item.qty ? 'text-red-500' : (totalPicked < item.qty ? 'text-orange-500' : 'text-emerald-500');
                        return `<div class="bg-white rounded-3xl shadow-soft border border-slate-200 overflow-hidden">
                            <div class="p-5 border-b border-slate-50 flex justify-between items-start bg-slate-50/30"><div><span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200 mb-1 inline-block">${item.sku || '-'}</span><div class="font-bold text-slate-800 text-lg">${item.name}</div><div class="text-sm text-slate-500 mt-1">สั่ง: <b>${item.qty}</b> ${item.unit}</div></div><div class="text-right bg-white px-3 py-1 rounded-xl border border-slate-100"><div class="text-[10px] text-slate-400 font-bold uppercase">ยอดเบิก</div><div class="font-black text-xl ${statusColor}">${totalPicked}</div></div></div>
                            <div class="p-4 space-y-3" id="picks-container-${idx}">${this.renderPickRows(item, idx, canEdit, order.id)}</div>
                            ${canEdit ? `<div class="p-3 bg-slate-50 border-t border-slate-100"><button onclick="app.logic.addPick('${order.id}', ${idx})" class="w-full h-10 text-sm font-bold text-slate-600 bg-white border border-slate-200 hover:shadow-md rounded-xl flex items-center justify-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> เพิ่ม Lot</button></div>` : ''}
                        </div>`; }).join('')}</div>`;
                },
                renderPickRows(item, itemIdx, canEdit, orderId) {
                    const disabled = canEdit ? '' : 'disabled';
                    return item.picks.map((pick, pIdx) => `<div class="flex gap-3 items-center">
                        <div class="relative flex-1"><i data-lucide="scan-barcode" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i><input id="input-lot-${itemIdx}-${pIdx}" type="text" placeholder="Lot / Barcode" value="${pick.lot}" ${disabled} onchange="app.logic.updatePick('${orderId}', ${itemIdx}, ${pIdx}, 'lot', this.value)" class="w-full pl-10 pr-3 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:bg-white focus:border-blue-400 transition-colors"></div>
                        <div class="w-24"><input id="input-qty-${itemIdx}-${pIdx}" type="number" value="${pick.qty}" ${disabled} onchange="app.logic.updatePick('${orderId}', ${itemIdx}, ${pIdx}, 'qty', this.value)" onkeydown="if(event.key === 'Enter') { event.preventDefault(); app.logic.handleQtyEnter(this, ${itemIdx}, ${pIdx}, '${orderId}'); }" class="w-full py-3 text-center text-sm font-bold bg-slate-50 border border-slate-200 rounded-xl outline-none focus:bg-white focus:border-blue-400"></div>
                        ${canEdit ? `<button onclick="app.logic.removePick('${orderId}', ${itemIdx}, ${pIdx})" class="p-3 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-xl"><i data-lucide="trash-2" class="w-5 h-5"></i></button>` : ''}</div>`).join('');
                },
                renderQCContent(order, canEdit) {
                    let topBar = '';
                    if (canEdit) {
                        topBar = `
                        <div class="flex justify-end mb-4">
                            <button onclick="app.logic.passAllQC('${order.id}')" class="bg-emerald-100 text-emerald-700 px-4 py-2 rounded-xl font-bold text-sm hover:bg-emerald-200 transition-colors flex items-center gap-2 shadow-sm">
                                <i data-lucide="check-check" class="w-4 h-4"></i> ผ่าน QC ทั้งหมด
                            </button>
                        </div>`;
                    }
                    return `${topBar}<div class="space-y-4">${order.items.map((item, idx) => {
                         const isComplete = (item.passed + item.failed) === item.qty;
                         return `<div class="bg-white rounded-3xl shadow-soft border ${isComplete ? 'border-emerald-500 ring-1 ring-emerald-100' : 'border-slate-200'} overflow-hidden">
                            <div class="p-5 border-b border-slate-50 flex justify-between items-start"><div><span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200 mb-1 inline-block">${item.sku || '-'}</span><div class="font-bold text-slate-800 text-lg">${item.name}</div><div class="flex flex-wrap gap-2 mt-2">${item.picks.map(p => `<span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded border border-slate-200 font-mono">LOT: ${p.lot}</span>`).join('')}</div></div><div class="text-right"><span class="text-xs font-bold bg-white border border-slate-200 text-slate-600 px-3 py-1 rounded-xl">จำนวน: ${item.qty}</span></div></div>
                            <div class="p-5 space-y-4">
                                <div class="flex gap-4">
                                    <div class="flex-1 bg-emerald-50 p-3 rounded-2xl border border-emerald-100"><label class="text-xs font-bold text-emerald-700 mb-2 block">ผ่าน (Pass)</label><input id="qc-pass-${idx}" type="number" value="${item.passed}" ${canEdit?'':'disabled'} onchange="app.logic.setQC('${order.id}', ${idx}, 'passed', this.value)" onkeydown="if(event.key === 'Enter') app.logic.handleQCEnter(this, ${idx}, 'pass')" class="w-full text-center text-3xl font-bold text-emerald-600 bg-white border border-emerald-200 rounded-xl py-2 outline-none"></div>
                                    <div class="flex-1 bg-rose-50 p-3 rounded-2xl border border-rose-100"><label class="text-xs font-bold text-rose-700 mb-2 block">ไม่ผ่าน (Fail)</label><input id="qc-fail-${idx}" type="number" value="${item.failed}" ${canEdit?'':'disabled'} onchange="app.logic.setQC('${order.id}', ${idx}, 'failed', this.value)" onkeydown="if(event.key === 'Enter') app.logic.handleQCEnter(this, ${idx}, 'fail')" class="w-full text-center text-3xl font-bold text-rose-600 bg-white border border-rose-200 rounded-xl py-2 outline-none"></div>
                                </div>
                                <div class="${item.failed > 0 ? '' : 'hidden'} bg-rose-50 p-3 rounded-2xl border border-rose-100"><label class="text-[10px] font-bold text-rose-500">สาเหตุที่สินค้าไม่ผ่าน</label><input type="text" placeholder="ระบุสาเหตุ" value="${item.qc_reason}" ${canEdit?'':'disabled'} onchange="app.logic.updateQCReason('${order.id}', ${idx}, this.value)" class="w-full bg-white border border-rose-200 text-rose-800 text-sm rounded-lg p-2 mt-1 outline-none"></div>
                            </div>
                        </div>`; }).join('')}</div>`;
                },
                renderPackContent(order, canEdit) {
                    let mainContent = '';
                    if (canEdit) {
                        const currentBoxNum = (order.boxes ? order.boxes.length : 0) + 1;
                        const itemsInCurrentBox = order.active_box ? order.active_box.total_qty : 0;
                        
                        // Check if all items complete
                        const allComplete = order.items.every(i => (i.packed_qty || 0) >= i.qty);

                        // Last Scanned Item Card (The big top card)
                        let scannedItemCard = '';
                        if (app.session.selectedPackIndex !== null && app.session.selectedPackIndex !== undefined) {
                            const item = order.items[app.session.selectedPackIndex];
                            const productData = app.data.products.find(p => p.sku === item.sku); 
                            const barcode = productData ? productData.barcode : (item.sku || '-');
                            
                            scannedItemCard = `
                                <div class="bg-blue-600 rounded-2xl p-6 mb-4 shadow-xl text-white transform transition-all animate-pop">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="bg-white/20 px-3 py-1 rounded-lg text-sm font-bold backdrop-blur-sm">📦 กำลังแพ็ค</span>
                                        <span class="text-2xl font-black">${item.packed_qty} / ${item.qty}</span>
                                    </div>
                                    <h2 class="text-2xl font-bold leading-tight mb-2">${item.name}</h2>
                                    <div class="flex items-center gap-2 opacity-80 font-mono text-sm">
                                        <i data-lucide="scan-barcode" class="w-4 h-4"></i> ${barcode}
                                    </div>
                                </div>
                            `;
                        }

                        mainContent = `
                        <div class="flex-1 w-full min-w-0">
                            <div class="sticky top-0 z-20 -mx-4 -mt-4 mb-4 px-4 pt-4 pb-2 bg-slate-50/95 backdrop-blur space-y-3">
                                
                                ${scannedItemCard}

                                <!-- Box Management Dashboard -->
                                <div class="bg-white rounded-2xl p-4 shadow-sm border border-blue-100 flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600">
                                            <i data-lucide="box" class="w-6 h-6"></i>
                                        </div>
                                        <div>
                                            <div class="text-xs text-slate-400 font-bold uppercase">Current Box</div>
                                            <div class="text-lg font-black text-slate-800">กล่องที่ ${currentBoxNum} <span class="text-sm font-normal text-slate-400">(${itemsInCurrentBox} ชิ้น)</span></div>
                                        </div>
                                    </div>
                                    <button onclick="app.logic.closeBox('${order.id}')" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-md hover:bg-blue-700 transition-colors">
                                        ปิดกล่อง
                                    </button>
                                </div>

                                <div class="flex gap-3 items-stretch">
                                    <div class="bg-white px-2 py-1 rounded-2xl shadow-lg border-2 border-slate-200 flex flex-col justify-center items-center w-20">
                                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">จำนวน</span>
                                        <input type="number" id="pack-qty-input" value="1" min="1" class="w-full text-center text-xl font-bold text-blue-600 outline-none bg-transparent" onfocus="this.select()">
                                    </div>
                                    <div class="bg-white p-3 rounded-2xl shadow-lg border-2 border-blue-100 flex gap-3 items-center flex-1">
                                        <div class="bg-blue-500 text-white p-3 rounded-xl animate-pulse"><i data-lucide="scan-barcode" class="w-6 h-6"></i></div>
                                        <input type="text" id="pack-scan-input" placeholder="ยิงบาร์โค้ดสินค้าที่นี่..." class="flex-1 text-lg font-bold outline-none text-slate-700 placeholder:text-slate-300 placeholder:font-normal" autocomplete="off" onkeydown="if(event.key === 'Enter') { app.logic.scanPackItem('${order.id}', this.value); this.value=''; }">
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-3 pb-20">
                                ${allComplete ? `
                                    <div class="text-center p-10 bg-emerald-50 rounded-3xl border-2 border-dashed border-emerald-200 animate-fade-in">
                                        <div class="inline-flex p-4 bg-emerald-100 text-emerald-600 rounded-full mb-3">
                                            <i data-lucide="check-check" class="w-8 h-8"></i>
                                        </div>
                                        <h3 class="text-emerald-800 font-bold text-lg">สินค้าครบตามจำนวนสั่งแล้ว</h3>
                                        <p class="text-emerald-600 text-sm">กรุณาตรวจทานและกด "ปิดกล่อง" หรือ "ยืนยันแพ็คเสร็จสิ้น"</p>
                                    </div>
                                ` : ''}

                                ${order.items.map((item, idx) => {
                                    const packedQty = item.packed_qty || 0;
                                    const isComplete = packedQty >= item.qty;
                                    
                                    // *** AUTO HIDE COMPLETED ITEMS ***
                                    if (isComplete) return '';

                                    const productData = app.data.products.find(p => p.sku === item.sku); 
                                    const barcode = productData ? productData.barcode : (item.sku || '-');
                                    const percent = Math.min(100, Math.round((packedQty / item.qty) * 100));
                                    
                                    // Current box qty for this item
                                    const inBoxQty = (order.active_box && order.active_box.items && order.active_box.items[item.sku]) || 0;

                                    // Focus Mode Logic
                                    const isSelected = app.session.selectedPackIndex === idx;
                                    const rowClass = isSelected ? 'ring-4 ring-blue-400 bg-blue-50/50 transform scale-[1.01]' : 'border-slate-100';
                                    
                                    return `
                                    <div id="pack-item-${idx}" onclick="app.logic.selectPackItem('${order.id}', ${idx})" class="cursor-pointer bg-white rounded-3xl border ${rowClass} shadow-soft overflow-hidden transition-all duration-200 relative group">
                                        <div class="p-4 flex gap-4 items-center">
                                            <!-- Indicator -->
                                            <div class="shrink-0">
                                                <div class="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center font-bold text-slate-400 text-sm">
                                                    ${idx + 1}
                                                </div>
                                            </div>
                                            
                                            <div class="flex-1 min-w-0">
                                                <div class="flex justify-between items-start mb-2">
                                                    <h3 class="font-bold text-slate-800 text-base truncate pr-2 ${isSelected ? 'text-blue-700' : ''} leading-tight">${item.name}</h3>
                                                    
                                                    <!-- Controls -->
                                                    <div class="flex items-center gap-3" onclick="event.stopPropagation()">
                                                        <button onclick="app.logic.adjustPackQty('${order.id}', ${idx}, -1)" class="w-8 h-8 rounded-xl bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-slate-700 flex items-center justify-center transition-colors"><i data-lucide="minus" class="w-5 h-5"></i></button>
                                                        <span class="text-2xl font-black w-10 text-center ${packedQty >= item.qty ? 'text-emerald-600' : 'text-blue-600'}">${packedQty}</span>
                                                        <button onclick="app.logic.adjustPackQty('${order.id}', ${idx}, 1)" class="w-8 h-8 rounded-xl bg-blue-50 text-blue-600 hover:bg-blue-100 flex items-center justify-center transition-colors"><i data-lucide="plus" class="w-5 h-5"></i></button>
                                                    </div>
                                                </div>
                                                
                                                <div class="flex items-center justify-between gap-2">
                                                    <div class="text-xs text-slate-400 font-mono flex items-center gap-2">
                                                        <span class="bg-slate-50 px-2 py-1 rounded border border-slate-200"><i data-lucide="scan-barcode" class="w-3 h-3 inline mr-1"></i>${barcode}</span>
                                                        ${inBoxQty > 0 ? `<span class="text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded border border-emerald-100 animate-pop">(+${inBoxQty} ในกล่องนี้)</span>` : ''}
                                                    </div>
                                                    
                                                    <!-- Order Quantity -->
                                                    <div class="flex items-baseline gap-1 text-slate-500 text-xs">
                                                        <span>สั่ง:</span>
                                                        <span class="text-xl font-black text-black">${item.qty}</span>
                                                        <span>${item.unit}</span>
                                                    </div>
                                                </div>

                                                <div class="mt-3 relative h-2 bg-slate-100 rounded-full overflow-hidden">
                                                    <div class="absolute top-0 left-0 h-full bg-blue-500 progress-bar" style="width: ${percent}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>`;
                    } else {
                        // Read-only view for finished pack
                        mainContent = `<div class="space-y-4">
                            <div class="bg-slate-800 text-white p-4 rounded-2xl shadow-lg flex items-center justify-between">
                                <div><div class="text-xs opacity-70 uppercase tracking-widest">จำนวนกล่องทั้งหมด</div><div class="text-2xl font-bold">${order.boxes ? order.boxes.length : 0} กล่อง</div></div>
                                <i data-lucide="package" class="w-8 h-8 opacity-50"></i>
                            </div>
                            <div class="space-y-3">${order.items.map((item, idx) => {
                            return `<div class="bg-white p-4 rounded-3xl border border-slate-100 flex items-center justify-between shadow-soft">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-4 h-4"></i></div>
                                    <div>
                                        <div class="font-bold text-slate-700 text-sm">${item.name}</div>
                                        <div class="text-xs text-slate-400">แพ็คแล้ว: ${item.packed_qty || item.qty} / ${item.qty}</div>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}</div></div>`;
                    }

                    // Packed Boxes List (Visible in both Edit and Read-only)
                    let rightColumnHtml = '';
                    if (order.boxes && order.boxes.length > 0) {
                        rightColumnHtml = `
                            <div class="w-full lg:w-80 shrink-0 lg:sticky lg:top-4 mt-8 lg:mt-0">
                                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
                                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 border-b border-slate-100 pb-3">
                                        <i data-lucide="package-check" class="w-5 h-5 text-emerald-500"></i> 
                                        แพ็คเสร็จแล้ว (${order.boxes.length})
                                    </h3>
                                    <div class="space-y-3 max-h-[calc(100vh-200px)] overflow-y-auto pr-1">
                                        ${order.boxes.map((box, index) => `
                                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 hover:bg-white hover:shadow-md transition-all group">
                                                <div class="flex justify-between items-center mb-2">
                                                    <span class="font-bold text-slate-800 text-sm">กล่องที่ ${index + 1}</span>
                                                    <span class="text-[10px] font-bold bg-white border border-slate-200 text-slate-500 px-2 py-0.5 rounded-lg shadow-sm">${box.total_qty} ชิ้น</span>
                                                </div>
                                                <div class="space-y-1 mb-3">
                                                    ${Object.entries(box.items).map(([sku, qty]) => {
                                                        const prod = app.data.products.find(p => p.sku === sku);
                                                        return `<div class="flex justify-between text-[10px] text-slate-500">
                                                            <span class="truncate pr-2">${prod ? prod.name : sku}</span>
                                                            <span class="font-bold text-slate-700">x${qty}</span>
                                                        </div>`;
                                                    }).join('')}
                                                </div>
                                                <button onclick="app.logic.openPrintLabelModal('${order.id}', ${index})" class="w-full py-2 rounded-lg bg-white border border-slate-200 text-slate-600 text-xs font-bold hover:text-blue-600 hover:border-blue-300 hover:bg-blue-50 transition-colors flex items-center justify-center gap-1.5 opacity-60 group-hover:opacity-100">
                                                    <i data-lucide="printer" class="w-3 h-3"></i> พิมพ์ Label
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    return `<div class="flex flex-col lg:flex-row gap-6 items-start">${mainContent}${rightColumnHtml}</div>`;
                },
                renderReadOnlyContent(order) {
                    return `<div class="space-y-3">${order.items.map(item => `<div class="bg-white p-5 rounded-3xl border border-slate-100 flex justify-between items-center shadow-soft"><div><span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200 mb-1 inline-block">${item.sku || '-'}</span><div class="font-bold text-slate-700">${item.name}</div><div class="text-xs text-slate-400 mt-1">ยอดสั่ง: ${item.qty} ${item.unit}</div></div><div class="bg-slate-50 px-4 py-2 rounded-xl border border-slate-100"><span class="font-bold text-slate-700 text-lg">${item.qty}</span></div></div>`).join('')}${order.status === 'completed' ? `<div class="bg-emerald-50 text-emerald-600 p-6 rounded-3xl text-center font-bold border border-emerald-100 flex flex-col items-center gap-2"><i data-lucide="check-circle" class="w-8 h-8"></i>ออเดอร์เสร็จสมบูรณ์</div>` : ''}</div>`;
                },
                cardStat(label, val, icon, bgClass) { return `<div class="bg-white p-5 rounded-3xl shadow-soft border border-slate-100 flex items-center justify-between"><div><p class="text-xs text-slate-500 font-bold uppercase tracking-wide mb-1">${label}</p><p class="text-3xl font-bold text-slate-800">${val}</p></div><div class="p-3.5 rounded-2xl ${bgClass}"><i data-lucide="${icon}" class="w-6 h-6"></i></div></div>`; }
            },

            logic: {
                openImportInventory() {
                    app.ui.modalHTML('นำเข้าสินค้า (Excel)', `
                        <div class="space-y-4">
                            <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center bg-slate-50 relative hover:bg-purple-50 transition-colors">
                                <input type="file" id="inv-file" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="document.getElementById('file-name').innerText = this.files[0].name">
                                <i data-lucide="upload-cloud" class="w-10 h-10 text-purple-400 mx-auto mb-2"></i>
                                <p class="text-sm font-bold text-slate-600">คลิกเพื่อเลือกไฟล์ Excel</p>
                                <p id="file-name" class="text-xs text-slate-400 mt-1">รองรับ .xlsx, .xls</p>
                            </div>
                            <div class="text-xs text-slate-500 bg-slate-100 p-3 rounded-lg border border-slate-200">
                                <b>รูปแบบไฟล์ (Columns):</b><br>A: รหัส SKU<br>B: ชื่อสินค้า<br>C: บาร์โค้ด
                            </div>
                        </div>
                    `, () => this.processInventoryImport(), 'นำเข้าข้อมูล');
                },

                // *** NEW: Add Product Modal Logic ***
                openAddProductModal() {
                    const html = `
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">SKU <span class="text-red-500">*</span></label>
                                <input type="text" id="new-prod-sku" class="input-field w-full" placeholder="Ex. FG-001">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">ชื่อสินค้า <span class="text-red-500">*</span></label>
                                <input type="text" id="new-prod-name" class="input-field w-full" placeholder="ชื่อสินค้า...">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">บาร์โค้ด</label>
                                <input type="text" id="new-prod-barcode" class="input-field w-full" placeholder="สแกนหรือพิมพ์...">
                            </div>
                        </div>
                    `;
                    app.ui.modalHTML('เพิ่มสินค้าใหม่', html, () => {
                        const sku = document.getElementById('new-prod-sku').value.trim();
                        const name = document.getElementById('new-prod-name').value.trim();
                        const barcode = document.getElementById('new-prod-barcode').value.trim();
                        
                        if(!sku || !name) {
                            return app.ui.toast('กรุณากรอก SKU และชื่อสินค้า', 'error');
                        }
                        
                        // Check duplicate SKU
                        if(app.data.products.some(p => p.sku === sku)) {
                            return app.ui.toast('SKU นี้มีอยู่แล้วในระบบ', 'error');
                        }

                        app.data.products.push({ sku, name, barcode });
                        app.saveData();
                        app.views.renderInventoryList(); // Refresh list if currently on inventory page
                        app.ui.toast('เพิ่มสินค้าเรียบร้อยแล้ว');
                    }, 'บันทึก');
                },
                
                // *** NEW: Delete Product Logic ***
                deleteProduct(sku) {
                    const product = app.data.products.find(p => p.sku === sku);
                    if(!product) return;

                    app.ui.modalHTML('ยืนยันการลบ', `
                        <div class="text-center py-2">
                            <div class="mx-auto w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-3">
                                <i data-lucide="trash-2" class="w-6 h-6"></i>
                            </div>
                            <p class="text-slate-600 mb-1">คุณต้องการลบสินค้า</p>
                            <p class="font-bold text-slate-800 text-lg mb-2">${product.name}</p>
                            <p class="text-xs text-slate-400">SKU: ${sku}</p>
                        </div>
                    `, () => {
                        app.data.products = app.data.products.filter(p => p.sku !== sku);
                        app.saveData();
                        app.views.renderInventoryList();
                        app.ui.toast('ลบสินค้าสำเร็จ');
                    }, 'ลบสินค้า');
                    
                    // Style the confirm button to red
                    setTimeout(() => {
                        const btn = document.getElementById('modal-confirm');
                        if(btn) {
                            btn.className = "px-6 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-bold rounded-xl shadow-lg shadow-red-200 transition-colors";
                        }
                    }, 50);
                },
                
                // *** NEW: Delete Order Logic (For History) ***
                deleteOrder(id) {
                    // Confirmation logic
                     app.ui.modalHTML('ยืนยันการลบ', `
                        <div class="text-center py-4">
                            <div class="mx-auto w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-3">
                                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                            </div>
                            <p class="text-slate-600 mb-2">คุณต้องการลบออเดอร์นี้ใช่หรือไม่?</p>
                            <p class="font-bold text-slate-800 text-lg">${id}</p>
                        </div>
                    `, () => {
                        app.data.orders = app.data.orders.filter(o => o.id !== id);
                        app.saveData();
                        app.views.renderHistory(document.getElementById('main-view'));
                        app.ui.toast('ลบออเดอร์เรียบร้อยแล้ว');
                    }, 'ลบออเดอร์');
                    
                     setTimeout(() => {
                        const btn = document.getElementById('modal-confirm');
                        if(btn) {
                            btn.className = "px-6 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-bold rounded-xl shadow-lg shadow-red-200 transition-colors";
                        }
                    }, 50);
                },

                processInventoryImport() {
                    const fileInput = document.getElementById('inv-file');
                    if (!fileInput.files.length) return app.ui.toast('กรุณาเลือกไฟล์', 'error');
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

                            let count = 0;
                            for(let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if(row[0] && row[1]) {
                                    const newItem = {
                                        sku: String(row[0]).trim(),
                                        name: String(row[1]).trim(),
                                        barcode: row[2] ? String(row[2]).trim() : ''
                                    };
                                    const existIdx = app.data.products.findIndex(p => p.sku === newItem.sku);
                                    if(existIdx >= 0) app.data.products[existIdx] = newItem;
                                    else app.data.products.push(newItem);
                                    count++;
                                }
                            }
                            app.saveData();
                            app.views.renderInventoryList();
                            app.ui.toast(`นำเข้าสินค้าสำเร็จ ${count} รายการ`);
                        } catch(err) { app.ui.toast('ไฟล์ไม่ถูกต้อง', 'error'); }
                    };
                    reader.readAsArrayBuffer(fileInput.files[0]);
                },

                openImportOrderExcel() {
                    app.ui.modalHTML('นำเข้าใบเบิก (Excel / PDF)', `
                          <div class="space-y-4">
                            <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center bg-slate-50 relative hover:bg-green-50 transition-colors">
                                <input type="file" id="order-file" accept=".xlsx, .xls, .pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="document.getElementById('order-file-name').innerText = this.files[0].name">
                                <i data-lucide="file-down" class="w-10 h-10 text-green-500 mx-auto mb-2"></i>
                                <p class="text-sm font-bold text-slate-600">คลิกเพื่อเลือกไฟล์</p>
                                <p id="order-file-name" class="text-xs text-slate-400 mt-1">รองรับ Excel (.xlsx) และ PDF ใบเบิก</p>
                            </div>
                        </div>
                    `, () => this.processOrderImport(), 'เริ่มนำเข้า');
                },

                processOrderImport() {
                    const fileInput = document.getElementById('order-file');
                    if (!fileInput.files.length) return app.ui.toast('กรุณาเลือกไฟล์', 'error');
                    const file = fileInput.files[0];
                    const fileName = file.name.toLowerCase();
                    if (fileName.endsWith('.pdf')) { this.processPDF(file); } 
                    else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) { this.processExcel(file); } 
                    else { app.ui.toast('นามสกุลไฟล์ไม่ถูกต้อง', 'error'); }
                },

                async processPDF(file) {
                    try {
                        app.ui.toast('กำลังอ่านไฟล์ PDF...', 'info');
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        
                        const itemsList = document.getElementById('new-items-list');
                        itemsList.innerHTML = '';
                        let count = 0;

                        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                            const page = await pdf.getPage(pageNum);
                            const textContent = await page.getTextContent();
                            const items = textContent.items.map(item => ({ text: item.str, x: item.transform[4], y: item.transform[5] }));

                            items.sort((a, b) => {
                                const yDiff = Math.abs(a.y - b.y);
                                if (yDiff < 5) { return a.x - b.x; }
                                return b.y - a.y;
                            });

                            let lines = [];
                            let currentLine = [];
                            let lastY = -999;
                            items.forEach(item => {
                                if (lastY === -999 || Math.abs(item.y - lastY) < 5) { currentLine.push(item); lastY = item.y; } 
                                else { lines.push(currentLine); currentLine = [item]; lastY = item.y; }
                            });
                            if (currentLine.length > 0) lines.push(currentLine);

                            lines.forEach(line => {
                                const parts = line.map(i => i.text.trim()).filter(t => t);
                                if (parts.length >= 2) {
                                    const firstPart = parts[0];
                                    const lastPart = parts[parts.length - 1];
                                    const isSKU = /^[A-Z0-9]+-[A-Z0-9-]+/.test(firstPart);
                                    const isQty = /^[\d,]+\.\d{2}$/.test(lastPart);

                                    if (isSKU && isQty) {
                                        const sku = firstPart.trim();
                                        const qty = parseInt(lastPart.replace(/,/g, ''));
                                        let name = parts.length > 2 ? parts[1].trim() : '';
                                        
                                        // FIX: Robust Lookup
                                        const masterProd = app.data.products.find(p => p.sku.toLowerCase() === sku.toLowerCase());
                                        if (masterProd) name = masterProd.name;

                                        this.addInputRow(sku, name, qty);
                                        count++;
                                    }
                                }
                            });
                        }
                        if (count > 0) app.ui.toast(`นำเข้าสำเร็จ ${count} รายการ`);
                        else app.ui.toast('ไม่พบรายการสินค้าใน PDF', 'error');
                    } catch (error) { app.ui.toast('เกิดข้อผิดพลาดในการอ่าน PDF', 'error'); }
                },

                processExcel(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                            const itemsList = document.getElementById('new-items-list');
                            itemsList.innerHTML = ''; 
                            let count = 0;
                            jsonData.forEach(row => {
                                const keys = Object.keys(row);
                                const skuKey = keys.find(k => /sku|code|รหัส/i.test(k));
                                const nameKey = keys.find(k => /name|item|desc|สินค้า|รายการ/i.test(k));
                                const qtyKey = keys.find(k => /qty|amount|count|จำนวน/i.test(k));
                                if(nameKey && qtyKey) {
                                    const sku = skuKey ? String(row[skuKey]).trim() : '';
                                    let name = row[nameKey];
                                    const qty = row[qtyKey];
                                    
                                    // Fix Lookup here too
                                    if(sku) {
                                        const masterProd = app.data.products.find(p => p.sku.toLowerCase() === sku.toLowerCase());
                                        if (masterProd) name = masterProd.name;
                                    }

                                    if(name && qty) { this.addInputRow(sku, name, qty); count++; }
                                }
                            });
                            if(count === 0) app.ui.toast('ไม่พบข้อมูล (ตรวจสอบชื่อคอลัมน์)', 'error');
                            else app.ui.toast(`ดึงข้อมูลสำเร็จ ${count} รายการ`);
                        } catch(err) { app.ui.toast('อ่านไฟล์ Excel ไม่สำเร็จ', 'error'); }
                    };
                    reader.readAsArrayBuffer(file);
                },

                addInputRow(skuVal = '', nameVal = '', qtyVal = '') { 
                    const list = document.getElementById('new-items-list'); 
                    const div = document.createElement('div'); 
                    div.className = 'grid grid-cols-[180px_1fr_100px_100px_60px] gap-3 item-row animate-slide-up items-start relative'; 
                    div.innerHTML = `
                        <div class="w-full"><input type="text" placeholder="SKU" value="${skuVal}" class="input-field w-full text-sm item-sku bg-slate-50 text-slate-600 font-mono" readonly tabindex="-1"></div>
                        <div class="w-full relative group-input">
                            <div class="relative">
                                <input type="text" placeholder="พิมพ์ชื่อสินค้า..." value="${nameVal}" class="input-field w-full text-sm item-name font-bold focus:ring-2 focus:ring-blue-400 pr-10" 
                                    oninput="app.logic.searchProduct(this)" onfocus="app.logic.searchProduct(this)" onclick="this.select()" autocomplete="off">
                                <button class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-blue-500 p-1" onclick="this.previousElementSibling.focus(); app.logic.searchProduct(this.previousElementSibling, true)">
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="suggestions-box absolute top-full left-0 w-full bg-white shadow-xl rounded-xl border border-slate-100 mt-1 max-h-60 overflow-y-auto hidden z-50"></div>
                        </div>
                        <div class="w-full"><input type="number" placeholder="0" value="${qtyVal}" class="input-field w-full text-center text-sm item-qty font-bold text-blue-600"></div>
                        <div class="w-full"><input type="text" placeholder="หน่วย" value="ชิ้น" class="input-field w-full text-center text-sm item-unit text-slate-500"></div>
                        <div class="w-full flex justify-end"><button onclick="this.closest('.item-row').remove()" class="p-2 text-rose-400 hover:text-rose-600 rounded-lg hover:bg-rose-50 transition-colors"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>
                    `; 
                    list.appendChild(div); 
                    lucide.createIcons(); 
                },

                searchProduct(input, force = false) {
                    const val = input.value.toLowerCase();
                    const box = input.closest('.group-input').querySelector('.suggestions-box');
                    
                    if (val.length < 1 && !force) { 
                        box.innerHTML = ''; 
                        box.classList.add('hidden'); 
                        return; 
                    }

                    let matches = app.data.products;
                    if (val.length > 0) {
                        matches = matches.filter(p => p.name.toLowerCase().includes(val) || p.sku.toLowerCase().includes(val));
                    }

                    if (matches.length > 0) {
                        box.innerHTML = matches.map(p => `
                            <div onclick="app.logic.selectProduct(this, '${p.sku}', '${p.name.replace(/'/g, "\\'")}')" class="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50 last:border-0 transition-colors">
                                <div class="font-bold text-sm text-slate-700">${p.name}</div>
                                <div class="text-[10px] text-slate-400 font-mono mt-0.5">SKU: ${p.sku}</div>
                            </div>
                        `).join('');
                        box.classList.remove('hidden');
                    } else { 
                        box.innerHTML = `<div class="p-3 text-xs text-slate-400 text-center">ไม่พบสินค้า</div>`; 
                        box.classList.remove('hidden'); 
                    }
                },

                selectProduct(element, sku, name) {
                    const row = element.closest('.item-row');
                    row.querySelector('.item-name').value = name;
                    row.querySelector('.item-sku').value = sku;
                    const box = row.querySelector('.suggestions-box');
                    box.classList.add('hidden'); box.innerHTML = '';
                    row.querySelector('.item-qty').focus();
                },

                nextFocusTarget: null,

                handleQtyEnter(el, itemIdx, pickIdx, orderId) {
                    const nextItemIdx = itemIdx + 1;
                    const nextId = `input-qty-${nextItemIdx}-0`;
                    this.nextFocusTarget = nextId;
                    
                    // Trigger Update
                    el.blur(); 
                    
                    const order = app.data.orders.find(o => o.id === orderId);
                    if(order && nextItemIdx < order.items.length) {
                        const nextItem = order.items[nextItemIdx];
                        // If next item has no picks, add one
                        if(!nextItem.picks || nextItem.picks.length === 0) {
                           // This logic relies on updatePick -> refreshDetail
                           // But since updatePick is async/callback based, we might need to force add pick here?
                           // Actually, addPick will save and re-render.
                           app.logic.addPick(orderId, nextItemIdx);
                        }
                    }

                    setTimeout(() => {
                        const nextEl = document.getElementById(nextId);
                        if (nextEl && document.activeElement !== nextEl) {
                             nextEl.focus({preventScroll:true});
                             nextEl.select();
                             this.nextFocusTarget = null;
                        }
                    }, 100); // Increased timeout slightly for re-render
                },

                handleQCEnter(el, idx, type) {
                    let nextId = '';
                    if (type === 'pass') { nextId = `qc-fail-${idx}`; } 
                    else { nextId = `qc-pass-${idx + 1}`; }
                    this.nextFocusTarget = nextId;
                    el.blur(); 
                    setTimeout(() => {
                        const nextEl = document.getElementById(nextId);
                        if (nextEl && document.activeElement !== nextEl) {
                             nextEl.focus({preventScroll:true});
                             nextEl.select();
                             this.nextFocusTarget = null;
                        }
                    }, 50);
                },

                refreshDetail(id) {
                    const main = document.getElementById('main-view');
                    const scroller = document.getElementById('detail-scroller');
                    // Capture active element before render
                    const activeId = document.activeElement ? document.activeElement.id : null;
                    const savedScroll = scroller ? scroller.scrollTop : 0;
                    
                    app.views.renderDetail(main, id);
                    
                    // Prevent Jumpy Animation on Refresh
                    if(main.firstElementChild) {
                        main.firstElementChild.classList.remove('animate-slide-in-right');
                    }

                    const newScroller = document.getElementById('detail-scroller');
                    if(newScroller) newScroller.scrollTop = savedScroll;

                    // Smart Focus Restoration
                    if (app.logic.nextFocusTarget) {
                        const nextEl = document.getElementById(app.logic.nextFocusTarget);
                        if (nextEl) { nextEl.focus({preventScroll:true}); nextEl.select(); }
                        app.logic.nextFocusTarget = null;
                    } else if (activeId) {
                         const el = document.getElementById(activeId);
                         if(el) el.focus({preventScroll:true});
                    }
                },

                submitNewOrder() { 
                    const docNo = document.getElementById('new-doc').value || '-'; 
                    const customer = document.getElementById('new-customer').value;
                    const dateInput = document.getElementById('new-date').value;
                    const items = []; 
                    document.querySelectorAll('.item-row').forEach(row => { 
                        const sku = row.querySelector('.item-sku').value;
                        const name = row.querySelector('.item-name').value; 
                        const qty = row.querySelector('.item-qty').value; 
                        const unit = row.querySelector('.item-unit').value; 
                        if(name && qty) items.push({ sku, name, qty: parseInt(qty), unit: unit || 'ชิ้น', picked: 0, lot: '', passed: 0, failed: 0, picks: [], qc_reason: '' }); 
                    }); 
                    if(!customer || items.length === 0) return app.ui.toast('กรอกข้อมูลไม่ครบ', 'error');
                    let dateStr = dateInput ? new Date(dateInput).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit'}) : new Date().toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit'});
                    const newOrder = { id: `ORD-${Date.now().toString().slice(-4)}`, docNo, customer, date: dateStr, status: 'pending_stock', items, logs: [{ action: 'สร้างออเดอร์', time: new Date().toLocaleString('th-TH'), user: app.currentUser.name }] }; 
                    app.data.orders.unshift(newOrder); app.saveData(); app.router('stock'); app.ui.toast('สร้างออเดอร์สำเร็จ'); 
                },
                togglePacked(id, itemIdx) {
                    if(app.currentUser.role !== 'pack' && app.currentUser.role !== 'manager') return;
                    const order = app.data.orders.find(o => o.id === id);
                    if(order) {
                        if(order.items[itemIdx].packed === undefined) order.items[itemIdx].packed = false;
                        order.items[itemIdx].packed = !order.items[itemIdx].packed;
                        app.saveData();
                        this.refreshDetail(id);
                    }
                },
                
                selectPackItem(orderId, idx) {
                    if (app.session.selectedPackIndex === idx) {
                        app.session.selectedPackIndex = null; 
                    } else {
                        app.session.selectedPackIndex = idx; 
                    }
                    this.refreshDetail(orderId);
                    setTimeout(() => { document.getElementById('pack-scan-input')?.focus({preventScroll:true}); }, 50);
                },

                scanPackItem(orderId, barcode) {
                    barcode = barcode.trim();
                    if(!barcode) return;

                    const qtyInput = document.getElementById('pack-qty-input');
                    let multiplier = 1;
                    if(qtyInput && qtyInput.value) {
                        multiplier = parseInt(qtyInput.value);
                        if(isNaN(multiplier) || multiplier < 1) multiplier = 1;
                    }

                    const order = app.data.orders.find(o => o.id === orderId);
                    if(!order) return;

                    const inputEl = document.getElementById('pack-scan-input');
                    let itemIndex = -1;
                    
                    const productInfo = app.data.products.find(p => p.barcode === barcode || p.sku === barcode);
                    if (productInfo) {
                        itemIndex = order.items.findIndex(i => i.sku === productInfo.sku);
                    } else {
                        itemIndex = order.items.findIndex(i => i.sku === barcode);
                    }

                    const selectedIdx = app.session.selectedPackIndex;
                    if (selectedIdx !== undefined && selectedIdx !== null) {
                        if (itemIndex !== -1 && itemIndex !== selectedIdx) {
                             app.ui.toast(`สินค้าไม่ตรงกับที่เลือก! (คุณเลือก: ${order.items[selectedIdx].name})`, 'error');
                             if(inputEl) {
                                inputEl.classList.add('bg-red-50', 'text-red-600', 'animate-shake');
                                setTimeout(()=> inputEl.classList.remove('bg-red-50', 'text-red-600', 'animate-shake'), 500);
                             }
                             return;
                        }
                        if (itemIndex === -1) {
                             app.ui.toast('ไม่พบสินค้านี้ (Wrong Item)', 'error');
                             if(inputEl) {
                                inputEl.classList.add('bg-red-50', 'text-red-600', 'animate-shake');
                                setTimeout(()=> inputEl.classList.remove('bg-red-50', 'text-red-600', 'animate-shake'), 500);
                             }
                             return;
                        }
                    } else {
                        if (itemIndex === -1) {
                            app.ui.toast('ไม่พบสินค้านี้ในออเดอร์', 'error');
                            if(inputEl) {
                                inputEl.classList.add('bg-red-50', 'text-red-600', 'animate-shake');
                                setTimeout(()=> inputEl.classList.remove('bg-red-50', 'text-red-600', 'animate-shake'), 500);
                            }
                            return;
                        }
                    }

                    const item = order.items[itemIndex];
                    const currentPacked = item.packed_qty || 0;

                    if (currentPacked + multiplier > item.qty) {
                        app.ui.toast(`จำนวนเกิน! (รับ: ${item.qty}, แพ็คแล้ว: ${currentPacked}, จะเพิ่ม: ${multiplier})`, 'warning');
                        if(inputEl) {
                            inputEl.classList.add('bg-orange-50', 'text-orange-600', 'animate-shake');
                            setTimeout(()=> inputEl.classList.remove('bg-orange-50', 'text-orange-600', 'animate-shake'), 500);
                        }
                        return;
                    }

                    // Increment Global Packed Qty
                    item.packed_qty = currentPacked + multiplier;
                    
                    // Increment Box Tracking Qty
                    if (!order.active_box) order.active_box = { items: {}, total_qty: 0 };
                    if (!order.active_box.items[item.sku]) order.active_box.items[item.sku] = 0;
                    order.active_box.items[item.sku] += multiplier;
                    order.active_box.total_qty += multiplier;

                    app.saveData();
                    this.refreshDetail(orderId);
                    app.ui.toast(`แพ็ค "${item.name}" เพิ่ม ${multiplier} ชิ้น`);
                    
                    // Re-focus without scrolling
                    setTimeout(() => { 
                        const scanIn = document.getElementById('pack-scan-input');
                        if(scanIn) scanIn.focus({preventScroll:true}); 
                    }, 50);
                },

                closeBox(orderId) {
                    const order = app.data.orders.find(o => o.id === orderId);
                    if (!order.active_box || order.active_box.total_qty === 0) {
                        return app.ui.toast('กล่องยังว่างอยู่ ไม่สามารถปิดได้', 'warning');
                    }

                    // Push current active box to history
                    order.boxes.push(JSON.parse(JSON.stringify(order.active_box)));
                    
                    // Reset Active Box
                    order.active_box = { items: {}, total_qty: 0 };
                    
                    app.saveData();
                    this.refreshDetail(orderId);
                    
                    // Show animation or confirmation
                    app.ui.toast(`ปิดกล่องที่ ${order.boxes.length} เรียบร้อยแล้ว`, 'success');
                },

                openPrintLabelModal(orderId, boxIdx) {
                    const order = app.data.orders.find(o => o.id === orderId);
                    const box = order.boxes[boxIdx];
                    
                    const itemsHtml = Object.entries(box.items).map(([sku, qty]) => {
                        const prod = app.data.products.find(p => p.sku === sku);
                        const name = prod ? prod.name : sku;
                        return `
                            <div class="flex items-center justify-between py-2 border-b border-slate-100 last:border-0">
                                <div class="flex-1 pr-4">
                                    <div class="text-sm font-bold text-slate-700">${name}</div>
                                    <div class="text-[10px] text-slate-400 font-mono">${sku}</div>
                                </div>
                                <div class="w-20">
                                    <input type="number" id="print-qty-${sku}" value="${qty}" class="w-full text-center bg-slate-50 border border-slate-200 rounded-lg py-1 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-400" min="0">
                                </div>
                            </div>
                        `;
                    }).join('');

                    const html = `
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <h4 class="font-bold text-blue-800 mb-1">กล่องที่ ${boxIdx + 1}</h4>
                                <p class="text-xs text-blue-600">ตรวจสอบและแก้ไขจำนวนสินค้าก่อนพิมพ์ Label</p>
                            </div>
                            <div class="max-h-60 overflow-y-auto pr-1">
                                ${itemsHtml}
                            </div>
                        </div>
                    `;

                    app.ui.modalHTML('พิมพ์ Label กล่องสินค้า', html, () => {
                        // Collect updated quantities
                        const updatedItems = {};
                        let totalQty = 0;
                        Object.keys(box.items).forEach(sku => {
                            const el = document.getElementById(`print-qty-${sku}`);
                            if (el) {
                                const newQty = parseInt(el.value) || 0;
                                if (newQty > 0) {
                                    updatedItems[sku] = newQty;
                                    totalQty += newQty;
                                }
                            }
                        });
                        
                        // Print Logic (Simulation)
                        app.logic.printLabel(orderId, boxIdx, updatedItems, totalQty);
                    }, 'พิมพ์ Label');
                },

                printLabel(orderId, boxIdx, items, totalQty) {
                    const order = app.data.orders.find(o => o.id === orderId);
                    const boxNumber = boxIdx + 1;
                    const today = new Date().toLocaleString('th-TH');
                    
                    // Generate Table Rows
                    let rows = '';
                    Object.entries(items).forEach(([sku, qty]) => {
                         const prod = app.data.products.find(p => p.sku === sku);
                         const name = prod ? prod.name : sku;
                         rows += `
                            <tr class="border-b border-gray-300">
                                <td class="py-2 pr-2 align-top">
                                    <div class="font-bold text-sm text-gray-800">${name}</div>
                                    <div class="text-[10px] text-gray-500 font-mono">${sku}</div>
                                </td>
                                <td class="text-right align-top font-bold text-lg py-2">${qty}</td>
                            </tr>`;
                    });

                    // Label HTML Content
                    const labelContent = `
                        <div class="w-[350px] mx-auto border-2 border-black p-4 rounded-xl bg-white text-black font-sans">
                            <div class="mb-4 text-center border-b-2 border-black pb-4">
                                <div class="text-xs text-gray-500 uppercase font-bold">Customer</div>
                                <div class="text-3xl font-black leading-tight mb-2">${order.customer}</div> <!-- Increased size -->
                                <div class="flex justify-center gap-3 mt-1 text-xs text-gray-500">
                                    <span>${order.docNo}</span>
                                    <span>•</span>
                                    <span>${today}</span>
                                </div>
                            </div>
                            
                            <div class="text-center mb-6">
                                <div class="inline-block border-2 border-black text-2xl font-bold px-4 py-2 rounded-lg mb-1">BOX ${boxNumber}</div> <!-- Decreased size and border thickness -->
                                <div class="text-xs font-bold uppercase tracking-wide text-gray-400">PACKING LABEL</div>
                            </div>

                            <table class="w-full mb-4">
                                <thead>
                                    <tr class="text-xs uppercase text-gray-500 border-b-2 border-black">
                                        <th class="text-left py-1">Item</th>
                                        <th class="text-right py-1">Qty</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows}
                                </tbody>
                                <tfoot>
                                    <tr class="border-t-2 border-black">
                                        <td class="font-black py-2 text-lg">TOTAL</td>
                                        <td class="text-right font-black py-2 text-lg">${totalQty}</td>
                                    </tr>
                                </tfoot>
                            </table>

                            <div class="text-center text-[10px] text-gray-400 mt-4 border-t border-gray-200 pt-2">
                                Checked by: ${app.currentUser.name} • Warehouse QC System
                            </div>
                        </div>
                    `;

                    // Create a hidden iframe for printing (Better than overwriting body styles)
                    let printFrame = document.getElementById('print-frame');
                    if (!printFrame) {
                        printFrame = document.createElement('iframe');
                        printFrame.id = 'print-frame';
                        printFrame.style.position = 'fixed';
                        printFrame.style.right = '0';
                        printFrame.style.bottom = '0';
                        printFrame.style.width = '0';
                        printFrame.style.height = '0';
                        printFrame.style.border = '0';
                        document.body.appendChild(printFrame);
                    }

                    const doc = printFrame.contentWindow.document;
                    doc.open();
                    doc.write(`
                        <html>
                        <head>
                            <title>Print Label - Box ${boxNumber}</title>
                            <script src="https://cdn.tailwindcss.com"><\/script>
                            <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
                            <style>
                                body { font-family: 'Sarabun', sans-serif; padding: 20px; margin: 0; }
                                @media print { 
                                    @page { size: auto; margin: 0mm; } 
                                    body { margin: 0; -webkit-print-color-adjust: exact; }
                                    .label-container { break-inside: avoid; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="label-container flex justify-center items-center p-4">
                                ${labelContent}
                            </div>
                            <script>
                                setTimeout(() => {
                                    window.print();
                                }, 800); 
                            <\/script>
                        </body>
                        </html>
                    `);
                    doc.close();
                },
                
                printPackingList(orderId) {
                    const order = app.data.orders.find(o => o.id === orderId);
                    if(!order.boxes || order.boxes.length === 0) return app.ui.toast('ยังไม่มีข้อมูลกล่องให้พิมพ์', 'error');

                    const dateStr = new Date().toLocaleString('th-TH');
                    
                    let boxesHtml = '';
                    order.boxes.forEach((box, i) => {
                        let itemsHtml = '';
                        Object.entries(box.items).forEach(([sku, qty]) => {
                             const p = app.data.products.find(x => x.sku === sku);
                             itemsHtml += `<tr class="border-b border-gray-200 text-sm"><td class="py-1">${p ? p.name : sku}</td><td class="py-1 text-right font-bold">${qty}</td></tr>`;
                        });
                        boxesHtml += `
                            <div class="mb-6 border border-gray-300 rounded-lg p-4 break-inside-avoid">
                                <div class="flex justify-between border-b-2 border-gray-800 pb-2 mb-2 font-bold text-lg">
                                    <span>BOX ${i+1}</span>
                                    <span>${box.total_qty} ชิ้น</span>
                                </div>
                                <table class="w-full">${itemsHtml}</table>
                            </div>
                        `;
                    });

                    const html = `
                        <div class="max-w-3xl mx-auto p-6 bg-white text-black">
                            <div class="text-center border-b-2 border-black pb-4 mb-6">
                                <h1 class="text-2xl font-bold">ใบรายการแพ็คสินค้า (Packing List)</h1>
                                <div class="flex justify-between mt-4 text-sm">
                                    <div class="text-left"><b>ลูกค้า:</b> ${order.customer}</div>
                                    <div class="text-right"><b>เลขที่:</b> ${order.docNo}<br><b>วันที่:</b> ${dateStr}</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                ${boxesHtml}
                            </div>
                            <div class="mt-8 pt-4 border-t border-gray-300 text-center text-xs text-gray-500">
                                ผู้ตรวจสอบ: ${app.currentUser.name} (รวม ${order.boxes.length} กล่อง)
                            </div>
                        </div>
                    `;
                    
                    let frame = document.getElementById('print-frame');
                    if(!frame) {
                        frame = document.createElement('iframe');
                        frame.id = 'print-frame';
                        frame.style.display = 'none';
                        document.body.appendChild(frame);
                    }
                    const doc = frame.contentWindow.document;
                    doc.open();
                    doc.write(`<html><head><title>Packing List</title><script src="https://cdn.tailwindcss.com"><\/script><link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet"><style>body{font-family:'Sarabun';}</style></head><body>${html}<script>setTimeout(()=>{window.print()},800)<\/script></body></html>`);
                    doc.close();
                },

                adjustPackQty(orderId, itemIdx, delta) {
                    const order = app.data.orders.find(o => o.id === orderId);
                    const item = order.items[itemIdx];
                    const newQty = (item.packed_qty || 0) + delta;
                    if(newQty < 0) return;
                    if(newQty > item.qty) return app.ui.toast('เกินจำนวนที่สั่ง', 'error');
                    
                    item.packed_qty = newQty;
                    app.saveData();
                    this.refreshDetail(orderId);
                },

                addPick(id, itemIdx) { 
                    const order = app.data.orders.find(o => o.id === id); 
                    order.items[itemIdx].picks.push({ lot: '', qty: '' }); 
                    app.saveData(); 
                    this.refreshDetail(id);
                },
                removePick(id, itemIdx, pickIdx) { 
                    const order = app.data.orders.find(o => o.id === id); 
                    order.items[itemIdx].picks.splice(pickIdx, 1); 
                    app.saveData(); 
                    this.refreshDetail(id);
                },
                updatePick(id, itemIdx, pickIdx, field, val) { 
                    const order = app.data.orders.find(o => o.id === id); 
                    order.items[itemIdx].picks[pickIdx][field] = field === 'qty' ? parseInt(val) : val; 
                    order.items[itemIdx].picked = order.items[itemIdx].picks.reduce((a,b)=>a+(parseInt(b.qty)||0),0); 
                    app.saveData(); 
                    this.refreshDetail(id);
                },
                validateStock(id) {
                    const order = app.data.orders.find(o => o.id === id);
                    const invalid = order.items.some(i => (i.picked||0) !== i.qty);
                    if(invalid) app.ui.toast('ยอดเบิกไม่ตรงกับยอดสั่ง', 'error'); else app.logic.moveStatus(id, 'pending_qc', 'เบิกครบถ้วน');
                },
                setQC(id, itemIdx, field, val) { 
                    const order = app.data.orders.find(o => o.id === id); 
                    order.items[itemIdx][field] = parseInt(val) || 0; 
                    app.saveData(); 
                    this.refreshDetail(id);
                },
                updateQCReason(id, itemIdx, val) { app.data.orders.find(o => o.id === id).items[itemIdx].qc_reason = val; app.saveData(); },
                submitQC(id) {
                    const order = app.data.orders.find(o => o.id === id);
                    const incomplete = order.items.some(i => (i.passed + i.failed) !== i.qty);
                    if(incomplete) return app.ui.toast('ตรวจสอบไม่ครบจำนวน', 'error');
                    if(order.items.some(i => i.failed > 0 && !i.qc_reason)) return app.ui.toast('ระบุสาเหตุสินค้าไม่ผ่าน', 'error');
                    if(order.items.some(i => i.failed > 0)) {
                         app.ui.modalHTML('แจ้งเตือน', `<p class="text-center text-slate-600">มีสินค้าไม่ผ่าน QC ระบบจะแยกใบงาน Rework</p>`, () => {
                             const rework = JSON.parse(JSON.stringify(order));
                             rework.id = order.id + '-R'; rework.docNo += ' (Rework)'; rework.status = 'pending_stock';
                             rework.items = order.items.filter(i => i.failed > 0).map(i => ({...i, qty: i.failed, picked:0, picks:[], passed:0, failed:0, qc_reason:''}));
                             rework.logs = [{action: 'สร้างใบแก้', time: new Date().toLocaleString(), user: 'System'}];
                             app.data.orders.unshift(rework);
                             order.items = order.items.map(i => ({...i, qty: i.passed, passed:0, failed:0}));
                             this.moveStatus(id, 'pending_pack', 'ผ่าน QC (แยกงานแก้)');
                         });
                    } else { this.moveStatus(id, 'pending_pack', 'ผ่าน QC ทั้งหมด'); }
                },
                moveStatus(id, status, log) { 
                    const order = app.data.orders.find(x => x.id === id); 
                    if (status === 'ready_ship') {
                        const notPacked = order.items.some(i => (i.packed_qty || 0) !== i.qty);
                        if(notPacked) return app.ui.toast('สินค้ายังแพ็คไม่ครบตามจำนวน', 'error');
                        
                        // Auto Close Last Box if not empty
                        if(order.active_box && order.active_box.total_qty > 0) {
                            order.boxes.push(JSON.parse(JSON.stringify(order.active_box)));
                            order.active_box = { items: {}, total_qty: 0 };
                        }
                    }
                    order.status = status; 
                    order.logs.push({action: log, time: new Date().toLocaleString('th-TH'), user: app.currentUser.name}); 
                    app.saveData(); 
                    app.router('dashboard'); 
                    app.ui.toast('อัปเดตสถานะสำเร็จ'); 
                }
            },

            ui: {
                toast(msg, type = 'success') {
                    const container = document.getElementById('toast-container');
                    const el = document.createElement('div');
                    let bgClass = 'bg-slate-800';
                    if(type === 'error') bgClass = 'bg-rose-500';
                    if(type === 'warning') bgClass = 'bg-orange-500';
                    
                    el.className = `${bgClass} text-white px-4 py-3 rounded-xl shadow-2xl text-sm font-medium animate-fade-in`;
                    el.innerText = msg;
                    container.appendChild(el);
                    setTimeout(() => el.remove(), 3000);
                },
                modalHTML(title, html, onConfirm, btnText='ยืนยัน') {
                    const overlay = document.getElementById('modal-overlay');
                    const content = document.getElementById('modal-content');
                    content.innerHTML = `<div class="px-6 pt-6 pb-4"><h3 class="text-xl font-bold text-slate-800">${title}</h3></div><div class="px-6 pb-4">${html}</div><div class="px-6 py-4 border-t border-slate-100 flex justify-end gap-3 bg-slate-50"><button id="modal-cancel" class="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-200 rounded-xl">ยกเลิก</button><button id="modal-confirm" class="px-6 py-2 btn-blue text-white text-sm font-bold rounded-xl shadow-lg shadow-blue-200">${btnText}</button></div>`;
                    overlay.classList.remove('hidden'); setTimeout(() => overlay.classList.remove('opacity-0'), 10);
                    const close = () => { overlay.classList.add('opacity-0'); setTimeout(() => overlay.classList.add('hidden'), 200); };
                    document.getElementById('modal-cancel').onclick = close;
                    document.getElementById('modal-confirm').onclick = () => { onConfirm(); close(); };
                },
                badge(status) {
                    const map = { 'pending_stock': 'bg-orange-100 text-orange-600', 'pending_qc': 'bg-rose-100 text-rose-600', 'pending_pack': 'bg-blue-100 text-blue-600', 'ready_ship': 'bg-emerald-100 text-emerald-600', 'completed': 'bg-slate-100 text-slate-600' };
                    return `<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${map[status] || 'bg-slate-100'}">${status.replace('_', ' ')}</span>`;
                }
            }
        };

        window.app = app;
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
